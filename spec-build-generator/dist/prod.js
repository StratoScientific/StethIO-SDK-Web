!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AudioEngine=t():e.AudioEngine=t()}(this,(function(){return(()=>{"use strict";var e={d:(t,i)=>{for(var o in i)e.o(i,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:i[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{default:()=>l});var i=function(){function e(e){this.worker=new Worker(e)}return e.prototype.setup=function(e,t){console.log("audio decoder setup called");for(var i=this,o=[],a=0;a<t.length;++a)o.push(t[a].data);return new Promise((function(a,n){i.worker.onmessage=function(e){if(0!==e.data.status)return console.log("audio decoder failed to set up"),console.log(e),void n(e.data);console.log("audio decoder setup ok"),a(e.data)},i.worker.postMessage({config:e,packets:t},o)}))},e.prototype.decode=function(e){var t=this;return new Promise((function(i,o){t.worker.onmessage=function(e){0===e.data.status?i(e.data):o(e.data)},t.worker.postMessage(e,[e.data])}))},e}(),o=function(){function e(e){this.worker=new Worker(e)}return e.prototype.setup=function(e){var t=this;return new Promise((function(i,o){t.worker.onmessage=function(e){if(0!==e.data.status)return console.log(e),void o(e.data);console.log("audio encoder setup ok"),i(e.data.packets)},t.worker.postMessage(e)}))},e.prototype.encode=function(e){var t=this;return new Promise((function(i,o){t.worker.onmessage=function(e){0===e.data.status?i(e.data.packets):o(e.data)},t.worker.postMessage(e)}))},e}(),a=function(){function e(e,t,i){var o=this;this.mode="HEART",this.drawOnScreen=function(){o.canvasContextXX.imageSmoothingEnabled=!1,o.canvasContextXX.drawImage(o.wf.offScreenCvs,0,0),o.playing&&requestAnimationFrame(o.drawOnScreen)},this.divID=t,this.mode=i?"HEART":"LUNG",this.context=e,this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=0,this.frqBuf=new Uint8Array(this.analyserNode.frequencyBinCount),this.floatFreqData=new Float32Array(this.analyserNode.frequencyBinCount),this.floatTimeData=new Float32Array(this.analyserNode.frequencyBinCount),this.wfNumPts=400,this.wfBufAry=[this.frqBuf],console.log(t),console.log(document.getElementById(t)),this.canvas=document.getElementById(t);var a=this.canvas.getBoundingClientRect();this.targetWidth=Math.floor(a.width),this.targetHeight=Math.floor(a.height),this.wf=new n(this.wfBufAry,this.targetWidth,this.targetHeight,{},this,i),this.desiredMaxDB=0,this.gain=1,this.canvasContextXX=this.canvas.getContext("2d"),this.canvasContextXX.resetTransform()}return e.prototype.doGainAdjust=function(){for(var e=-100,t=0,i=0;i<this.floatFreqData.length/30;i++)this.floatFreqData[i]>e&&(e=this.floatFreqData[i]),this.floatFreqData[i]<t&&(t=this.floatFreqData[i]);var o=this.desiredMaxDB-e;this.gain=.985*this.gain+.015*o},e.prototype.convertToByteFrequencyData=function(){for(var e=12/this.floatFreqData.length,t=0;t<this.floatFreqData.length;t++){var i=this.floatFreqData[t]+this.gain,o=400*Math.pow(10,.05*i)*(1+e*t)-10;o>255&&(o=255),o<0&&(o=0),this.frqBuf[t]=o}},e.prototype.getCursorPosition=function(){this.analyserNode.getFloatTimeDomainData(this.floatTimeData);for(var e=0,t=0;t<this.floatTimeData.length/2;t++)e+=this.floatTimeData[t];return e/this.floatTimeData.length/2},e.prototype.getMaxMinPosition=function(){this.analyserNode.getFloatTimeDomainData(this.floatTimeData);for(var e=-1,t=1,i=0;i<this.floatTimeData.length/2;i++){var o=this.floatTimeData[i];o>e&&(e=o),o<t&&(t=o)}return[e,t]},e.prototype.adjustVerticalScaleByteBuffer=function(){for(var e=this.frqBuf.length;e>1;e--){var t=e/2,i=Math.round(t-1),o=Math.round(t),a=Math.round(t+1);this.frqBuf[e]=.25*this.frqBuf[i]+.5*this.frqBuf[o]+.25*this.frqBuf[a]}},e.prototype.beginDisplay=function(){this.wf.start(),this.playing=!0,this.drawOnScreen()},e.prototype.haltDisplay=function(){this.wf.pause(),this.playing=!1},e.prototype.stopDisplay=function(){this.wf.stop(),this.playing=!1},e.prototype.resumeDisplay=function(){this.wf.resume(),this.playing=!0,this.drawOnScreen()},e.prototype.alterPlayBackSpeed=function(e){this.wf.sgSetLineRate(e)},e}(),n=function(){function e(e,t,i,o,a,n){this.mode="HEART",this.heartMode=n,this.mode=n?"HEART":"LUNG",this.opt="object"==typeof o?o:{},this.ipBufAry=e,this.offScreenCtx,this.pxPerLine=t||200,this.lines=i>=200?i:200,this.lineRate=30,this.interval=0,this.startOfs=0,this.spectogramDrawer=a,this.vertLineBuf=new ArrayBuffer(4*parseInt(""+this.lines)),this.vertLineBuf8=new Uint8ClampedArray(this.vertLineBuf),this.vertLineImgData=new ImageData(this.vertLineBuf8,1,parseInt(""+this.lines)),this.ipBuf8=null,this.clearBuf=new ArrayBuffer(parseInt(""+this.pxPerLine)*parseInt(""+this.lines)*4),this.clearBuf8=new Uint8ClampedArray(this.clearBuf),this.buildColourMap();for(var r=0;r<this.pxPerLine*this.lines*4;r+=4)this.clearBuf8[r]=this.colMap[0][0],this.clearBuf8[r+1]=this.colMap[0][1],this.clearBuf8[r+2]=this.colMap[0][2],this.clearBuf8[r+3]=this.colMap[0][3];for(var s in this.clearImgData,this.nextLine=0,this.timerID=null,this.running=!1,this.sgTime=0,this.sgStartTime=0,this.demoCvsId="",this.opt)this.opt.hasOwnProperty(s)&&this.setProperty(s,this.opt[s]);this.offScreenCvs=document.createElement("canvas"),this.offScreenCvs.setAttribute("height",this.lines.toString()),this.offScreenCvs.setAttribute("width",this.pxPerLine.toString()),this.clearImgData=new ImageData(this.clearBuf8,parseInt(""+this.pxPerLine),parseInt(""+this.lines)),this.offScreenCtx=this.offScreenCvs.getContext("2d"),this.offScreenCtx.imageSmoothingEnabled=!1,this.offScreenCtx.strokeStyle="rgba(255, 255, 255, 1.0)",this.offScreenCtx.lineWidth=.5,"string"==typeof this.demoCvsId&&this.demoCvsId&&document.getElementById(this.demoCvsId).appendChild(this.offScreenCvs),this.stop()}return e.prototype.buildColourMap=function(){var e=this.mode;!e&&this.heartMode||"HEART"===e?this.colMap=[[0,0,0,255],[204,204,204,0],[177,152,204,1],[171,143,204,3],[166,136,204,4],[162,131,204,6],[159,127,204,7],[155,124,204,9],[152,120,204,10],[148,118,204,12],[145,115,204,14],[142,113,204,15],[139,111,204,17],[136,108,204,18],[133,107,204,20],[130,105,204,21],[127,103,204,23],[124,101,204,25],[121,100,204,26],[118,98,204,28],[114,97,204,29],[111,96,204,31],[108,94,204,32],[105,93,204,34],[102,92,204,36],[99,91,204,37],[96,89,204,39],[93,88,204,40],[90,87,204,42],[87,86,204,43],[85,86,204,45],[84,88,204,46],[83,89,204,48],[82,90,204,49],[81,91,204,51],[80,93,204,53],[79,94,204,54],[78,95,204,56],[78,97,204,57],[77,98,204,59],[76,100,204,60],[75,102,204,62],[74,103,204,63],[74,105,204,65],[73,107,204,66],[72,108,204,68],[71,110,204,69],[71,112,204,71],[70,114,204,72],[69,116,204,74],[68,118,204,75],[68,120,204,77],[67,122,204,78],[66,124,204,80],[66,126,204,81],[65,128,204,83],[64,130,204,84],[64,132,204,86],[63,134,204,87],[63,136,204,89],[62,139,204,90],[61,141,204,92],[61,143,204,93],[60,145,204,95],[60,148,204,96],[59,150,204,97],[59,152,204,99],[58,155,204,100],[57,157,204,102],[57,160,204,103],[56,162,204,105],[56,164,204,106],[55,167,204,108],[55,169,204,109],[54,172,204,110],[54,174,204,112],[53,177,204,113],[53,180,204,115],[52,182,204,116],[52,185,204,117],[51,187,204,119],[51,190,204,120],[50,193,204,122],[50,195,204,123],[49,198,204,124],[49,201,204,126],[48,204,204,127],[48,204,201,128],[48,204,198,130],[47,204,195,131],[47,204,192,132],[46,204,190,134],[46,204,187,135],[45,204,184,136],[45,204,181,138],[45,204,178,139],[44,204,175,140],[44,204,172,142],[43,204,170,143],[43,204,167,144],[42,204,164,146],[42,204,161,147],[42,204,158,148],[41,204,155,149],[41,204,152,151],[40,204,149,152],[40,204,146,153],[40,204,143,154],[39,204,140,156],[39,204,137,157],[39,204,134,158],[38,204,131,159],[38,204,127,161],[37,204,124,162],[37,204,121,163],[37,204,118,164],[36,204,115,165],[36,204,112,167],[36,204,109,168],[35,204,106,169],[35,204,102,170],[35,204,99,171],[34,204,96,172],[34,204,93,174],[33,204,89,175],[33,204,86,176],[33,204,83,177],[32,204,80,178],[32,204,76,179],[32,204,73,180],[31,204,70,181],[31,204,67,183],[31,204,63,184],[30,204,60,185],[30,204,57,186],[30,204,53,187],[29,204,50,188],[29,204,47,189],[29,204,43,190],[29,204,40,191],[28,204,36,192],[28,204,33,193],[28,204,30,194],[28,204,27,195],[31,204,27,196],[34,204,27,197],[37,204,26,198],[40,204,26,199],[42,204,26,200],[45,204,25,201],[48,204,25,202],[51,204,25,203],[54,204,25,204],[57,204,24,205],[60,204,24,206],[63,204,24,207],[66,204,23,208],[69,204,23,209],[72,204,23,209],[75,204,23,210],[78,204,22,211],[81,204,22,212],[84,204,22,213],[87,204,21,214],[90,204,21,215],[93,204,21,215],[96,204,21,216],[99,204,20,217],[102,204,20,218],[105,204,20,219],[108,204,19,220],[111,204,19,220],[114,204,19,221],[118,204,19,222],[121,204,18,223],[124,204,18,223],[127,204,18,224],[130,204,18,225],[133,204,17,226],[137,204,17,226],[140,204,17,227],[143,204,17,228],[146,204,16,228],[149,204,16,229],[153,204,16,230],[156,204,15,230],[159,204,15,231],[162,204,15,232],[166,204,15,232],[169,204,14,233],[172,204,14,234],[176,204,14,234],[179,204,14,235],[182,204,13,236],[186,204,13,236],[189,204,13,237],[192,204,13,237],[196,204,12,238],[199,204,12,238],[202,204,12,239],[204,201,12,239],[204,198,12,240],[204,194,11,241],[204,191,11,241],[204,188,11,242],[204,184,11,242],[204,181,10,243],[204,177,10,243],[204,174,10,243],[204,170,10,244],[204,167,9,244],[204,163,9,245],[204,160,9,245],[204,157,9,246],[204,153,8,246],[204,150,8,246],[204,146,8,247],[204,142,8,247],[204,139,8,248],[204,135,7,248],[204,132,7,248],[204,128,7,249],[204,125,7,249],[204,121,6,249],[204,118,6,250],[204,114,6,250],[204,110,6,250],[204,107,6,250],[204,103,5,251],[204,100,5,251],[204,96,5,251],[204,92,5,251],[204,89,4,252],[204,85,4,252],[204,81,4,252],[204,78,4,252],[204,74,4,253],[204,70,3,253],[204,67,3,253],[204,63,3,253],[204,59,3,253],[204,56,3,253],[204,52,2,254],[204,48,2,254],[204,45,2,254],[204,41,2,254],[204,37,2,254],[204,33,1,254],[204,30,1,254],[204,26,1,254],[204,22,1,254],[204,18,1,254],[204,15,0,254],[204,11,0,254],[204,7,0,254],[204,3,0,254],[204,0,0,255]]:this.colMap=[[0,0,0,255],[255,255,255,0],[221,191,255,3],[214,179,255,6],[208,171,255,9],[203,164,255,11],[198,159,254,14],[194,155,254,16],[190,151,254,18],[186,147,254,21],[182,144,254,23],[178,141,254,25],[174,138,254,27],[170,136,254,29],[166,133,254,31],[162,131,254,33],[158,129,254,35],[155,127,254,37],[151,125,254,39],[147,123,254,41],[143,121,254,43],[139,120,254,45],[136,118,254,47],[132,116,254,49],[128,115,254,51],[124,113,254,53],[120,112,254,55],[116,110,254,57],[112,109,254,58],[109,108,254,60],[106,108,254,62],[105,110,254,64],[104,111,254,66],[103,113,254,67],[102,114,254,69],[100,116,254,71],[99,118,254,73],[98,119,254,74],[97,121,254,76],[96,123,254,78],[95,125,254,79],[94,127,254,81],[93,129,254,83],[92,131,254,84],[91,133,254,86],[90,136,254,88],[89,138,254,89],[88,140,254,91],[87,142,254,92],[87,145,254,94],[86,147,254,96],[85,150,254,97],[84,152,254,99],[83,155,254,100],[82,157,254,102],[81,160,254,103],[81,162,254,105],[80,165,254,107],[79,168,254,108],[78,170,254,110],[78,173,254,111],[77,176,254,113],[76,179,254,114],[75,182,254,115],[75,185,254,117],[74,187,254,118],[73,190,254,120],[73,193,254,121],[72,196,254,123],[71,199,254,124],[70,202,254,126],[70,205,254,127],[69,208,254,128],[69,212,254,130],[68,215,254,131],[67,218,254,133],[67,221,254,134],[66,224,254,135],[65,227,254,137],[65,231,254,138],[64,234,254,139],[64,237,254,141],[63,240,254,142],[62,244,254,143],[62,247,254,145],[61,250,254,146],[61,254,254,147],[60,254,250,148],[59,254,247,150],[59,254,243,151],[58,254,240,152],[58,254,236,153],[57,253,233,155],[57,253,229,156],[56,253,226,157],[56,253,222,158],[55,253,218,160],[54,253,215,161],[54,253,211,162],[53,253,207,163],[53,253,204,164],[52,253,200,165],[52,253,196,167],[51,253,192,168],[51,253,189,169],[50,253,185,170],[50,253,181,171],[49,253,177,172],[49,253,173,173],[48,252,170,175],[48,252,166,176],[47,252,162,177],[47,252,158,178],[46,252,154,179],[46,252,150,180],[46,252,146,181],[45,252,142,182],[45,252,138,183],[44,252,134,184],[44,252,131,185],[43,251,127,186],[43,251,123,187],[42,251,119,188],[42,251,114,189],[41,251,110,190],[41,251,106,191],[41,251,102,192],[40,251,98,193],[40,251,94,194],[39,250,90,195],[39,250,86,196],[38,250,82,197],[38,250,78,198],[38,250,74,199],[37,250,70,200],[37,250,65,201],[36,249,61,202],[36,249,57,202],[35,249,53,203],[35,249,49,204],[35,249,45,205],[34,249,41,206],[34,249,36,207],[35,248,33,208],[38,248,33,208],[41,248,33,209],[45,248,32,210],[48,248,32,211],[52,247,31,212],[55,247,31,213],[59,247,31,213],[62,247,30,214],[66,247,30,215],[69,246,29,216],[73,246,29,216],[76,246,29,217],[79,246,28,218],[83,246,28,219],[86,245,28,219],[90,245,27,220],[94,245,27,221],[97,245,26,222],[101,244,26,222],[104,244,26,223],[108,244,25,224],[111,244,25,224],[115,243,25,225],[118,243,24,226],[122,243,24,226],[125,242,24,227],[129,242,23,228],[132,242,23,228],[136,242,23,229],[139,241,22,229],[143,241,22,230],[147,241,21,231],[150,240,21,231],[154,240,21,232],[157,240,20,232],[161,239,20,233],[164,239,20,234],[168,239,19,234],[171,238,19,235],[175,238,19,235],[178,238,18,236],[182,237,18,236],[185,237,18,237],[189,236,17,237],[192,236,17,238],[196,236,17,238],[199,235,17,239],[203,235,16,239],[206,234,16,240],[210,234,16,240],[213,234,15,241],[216,233,15,241],[220,233,15,242],[223,232,14,242],[227,232,14,242],[230,231,14,243],[231,228,13,243],[230,224,13,244],[230,220,13,244],[229,215,13,244],[229,211,12,245],[228,207,12,245],[228,202,12,246],[227,198,11,246],[227,194,11,246],[226,190,11,247],[226,185,10,247],[225,181,10,247],[225,177,10,248],[224,172,10,248],[223,168,9,248],[223,164,9,248],[222,159,9,249],[222,155,9,249],[221,151,8,249],[220,147,8,250],[220,142,8,250],[219,138,7,250],[219,134,7,250],[218,130,7,251],[217,126,7,251],[217,121,6,251],[216,117,6,251],[215,113,6,252],[214,109,6,252],[214,105,5,252],[213,101,5,252],[212,96,5,252],[212,92,5,252],[211,88,4,253],[210,84,4,253],[209,80,4,253],[209,76,4,253],[208,72,3,253],[207,68,3,253],[206,64,3,253],[205,60,3,254],[204,56,3,254],[204,52,2,254],[203,48,2,254],[202,44,2,254],[201,40,2,254],[200,37,1,254],[199,33,1,254],[198,29,1,254],[197,25,1,254],[197,21,1,254],[196,18,0,254],[195,14,0,254],[194,10,0,254],[193,7,0,254],[192,3,0,254],[191,0,0,255]]},e.prototype.incrLine=function(){this.nextLine++,this.nextLine>=this.lines&&(this.nextLine=0)},e.prototype.updateWaterfall=function(){var e=this.getDataOrganized();this.horizontalNewLine();var t=this.mode;if((!t&&this.heartMode||"HEART"===t)&&this.drawSoundLine(e),this.running){this.sgTime+=this.interval;var i=Date.now()-this.sgStartTime-this.sgTime,o=this;this.timerID=setTimeout((function(){o.updateWaterfall()}),this.interval-i)}},e.prototype.getDataOrganized=function(){this.spectogramDrawer.analyserNode.getFloatFrequencyData(this.spectogramDrawer.floatFreqData);var e=this.spectogramDrawer.getMaxMinPosition();return this.spectogramDrawer.doGainAdjust(),this.spectogramDrawer.convertToByteFrequencyData(),this.spectogramDrawer.adjustVerticalScaleByteBuffer(),e},e.prototype.drawSoundLine=function(e){var t=this.spectogramDrawer.targetHeight/200,i=this.spectogramDrawer.targetWidth/3,o=this.spectogramDrawer.targetHeight/(3*t),a=o-e[0]*i,n=o-e[1]*i;n-a<1&&(n=a+1);var r=this.offScreenCtx.globalCompositeOperation;this.offScreenCtx.globalCompositeOperation="source-over",this.offScreenCtx.beginPath(),this.offScreenCtx.translate(.5,0),this.offScreenCtx.moveTo(1,a),this.offScreenCtx.lineTo(1,n),this.offScreenCtx.stroke(),this.offScreenCtx.globalCompositeOperation=r,this.offScreenCtx.resetTransform()},e.prototype.sgSetLineRate=function(e){isNaN(e)||e<0?console.error("invalid line rate [0 <= lineRate]"):0===e?this.lineRate=0:(this.lineRate=e,this.interval=1e3/this.lineRate)},e.prototype.setProperty=function(e,t){if("string"==typeof e&&void 0!==t)switch(e.toLowerCase()){case"linerate":this.sgSetLineRate(t);break;case"startbin":!isNaN(t)&&t>0&&(this.startOfs=t);break;case"onscreenparentid":"string"==typeof t&&document.getElementById(t)&&(this.demoCvsId=t);break;case"colormap":if(Array.isArray(t)&&Array.isArray(t[0])&&4==t[0].length&&(this.colMap=t,this.colMap.length<256))for(var i=this.colMap.length;i<256;i++)this.colMap[i]=this.colMap[this.colMap.length-1]}},e.prototype.horizontalNewLine=function(){var e;e=this.ipBufAry[0].constructor!==Uint8Array?Uint8ClampedArray.from(this.ipBufAry[0]):this.ipBufAry[0],this.offScreenCtx.globalCompositeOperation="copy",this.offScreenCtx.imageSmoothingEnabled=!1,this.offScreenCtx.drawImage(this.offScreenCtx.canvas,1,0),this.offScreenCtx.globalCompositeOperation="source-over";for(var t=this.lines-152,i=void 0,o=void 0,a=0;a<this.lines;a++)i=e[a-t]||0,o=this.colMap[i],this.addReplaceColorMap(o,a,0);this.offScreenCtx.putImageData(this.vertLineImgData,1,this.nextLine)},e.prototype.addReplaceColorMap=function(e,t,i){var o=4*(this.lines-1-t)+i;this.vertLineBuf8[o]=e[0],this.vertLineBuf8[o+1]=e[1],this.vertLineBuf8[o+2]=e[2];var a=this.mode;this.vertLineBuf8[o+3]="LUNG"===a?85:e[3]},e.prototype.clear=function(){this.offScreenCtx.putImageData(this.clearImgData,0,0),console.log(this.clearImgData),this.colMap=[]},e.prototype.start=function(){this.sgStartTime=Date.now(),this.sgTime=0,this.running=!0,this.updateWaterfall()},e.prototype.resume=function(){console.log(this.sgTime),this.running=!0,this.updateWaterfall()},e.prototype.pause=function(){this.running=!1,this.timerID&&clearTimeout(this.timerID),this.nextLine=0},e.prototype.stop=function(){this.running=!1,this.timerID&&clearTimeout(this.timerID),this.nextLine=0},e}(),r=function(e,t,i,o){return new(i||(i=Promise))((function(a,n){function r(e){try{c(o.next(e))}catch(e){n(e)}}function s(e){try{c(o.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,s)}c((o=o.apply(e,t||[])).next())}))},s=function(e,t){var i,o,a,n,r={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return n={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function s(n){return function(s){return function(n){if(i)throw new TypeError("Generator is already executing.");for(;r;)try{if(i=1,o&&(a=2&n[0]?o.return:n[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[2&n[0],a.value]),n[0]){case 0:case 1:a=n;break;case 4:return r.label++,{value:n[1],done:!1};case 5:r.label++,o=n[1],n=[0];continue;case 7:n=r.ops.pop(),r.trys.pop();continue;default:if(!((a=(a=r.trys).length>0&&a[a.length-1])||6!==n[0]&&2!==n[0])){r=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){r.label=n[1];break}if(6===n[0]&&r.label<a[1]){r.label=a[1],a=n;break}if(a&&r.label<a[2]){r.label=a[2],r.ops.push(n);break}a[2]&&r.ops.pop(),r.trys.pop();continue}n=t.call(e,r)}catch(e){n=[6,e],o=0}finally{i=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,s])}}},c=function(){function e(e,t){var i=this;this.lungGain=5,this.heartGain=1,this.mode="HEART",this.lowAudioFlag=0,this.filterFunctions={},this.decodedPackets=[],this.kAudioFrequencyExact=44100,this.importObject={imports:{imported_func:function(e){console.log(e)},wasi_unstable:function(){}}},this.audioInput=function(e){if(i.totalBytesIn+=e.byteLength,null==i.decoder)return i.decoderOperational=!1,i.packetsToDecode=[],void i.loadOpusDecoder().then((function(){i.decoderOperational=!0}),(function(e){console.log("decoder.decode error")}));var t={data:e};i.packetsToDecode.push(t),!i.decoderOperational&&i.packetsToDecode.length<3||i.decodePackets()},this.testAudioInput=function(e){var t="HEART"==i.mode;i.socketWorkletNode&&i.socketWorkletNode.port.postMessage({type:"samples",samples:e,heartMode:t,gain:t?i.heartGain:i.lungGain})},this.handleWorkletProcessorMessage=function(e){console.log("At handle events: ",e.data.outputs),i.socketWorkletNode.port.postMessage({type:"live",outputs:e.data.outputs})},this.old_handleWorkletProcessorMessage=function(e){if(console.log("handleWorkletProcessorMessage: ",e),1!==i.feedbackGain)for(var t=0;t<e.data.samples.length;t++)e.data.samples[t]=e.data.samples[t]*i.feedbackGain;i.buffersToEncode.push(e.data.samples),i.queueBufferForEncodingAndSend()},this.audioContext=null,this.micStream=null,this.micSourceNode=null,this.encoder=null,this.decoder=null,this.socketWorkletNode=null,this.totalBytesIn=0,this.totalSamplesIn=0,this.totalBytesSent=0,this.decoderOperational=!1,this.packetsToDecode=[],this.decodingPackets=!1,this.encodingBuffers=!1,this.buffersToEncode=[],this.analyser=null,this.analyserBufferSize=128,this.analyserData=null,this.feedbackGain=1,this.refreshTimer=0,this.divID=e,this.lowAudioFlag=0,t&&("HEART"==t.mode?(this.heartGain=+t.gain>0&&+t.gain<=3?+t.gain:1,this.mode="HEART"):"LUNG"==t.mode&&(this.lungGain=+t.gain>0&&+t.gain<=20?+t.gain:5,this.mode="LUNG"))}return e.initAudioEngine=function(t,i,o){return r(this,void 0,void 0,(function(){var a,n;return s(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),[4,fetch("".concat(this.endpoint,"/api/sdk/key/verify/?encrypt=false"),{method:"POST",redirect:"follow",referrerPolicy:"no-referrer",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:{key:i,device_id:""}})})];case 1:return[4,r.sent().json()];case 2:return(a=r.sent()).hasOwnProperty("is_active")&&1==a.is_active?(void 0===this._instance&&(this._instance=new e(t,o)),console.log("StethIO Spectrogram Initialized Successfully!"),[2,this._instance]):(console.log("SDK Key Invalid. StethIO Spectrogram Initialized Failed!"),[2]);case 3:return n=r.sent(),console.log(n),console.log("SDK Key Invalid. StethIO Spectrogram Initialized Failed!"),[2];case 4:return[2]}}))}))},e.prototype.startIt=function(e){return r(this,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return this.audioContext=new AudioContext({sampleRate:16e3}),this.biquadFilter=this.audioContext.createBiquadFilter(),this.distortion=this.audioContext.createWaveShaper(),this.gainNode=this.audioContext.createGain(),this.convolver=this.audioContext.createConvolver(),console.log("startIt start"),[4,this.audioContext.audioWorklet.addModule("assets/steth-worklet-processor.js",{credentials:"omit"})];case 1:return t.sent(),console.log("startIt"),[2,this.onModuleAdded(e)]}}))}))},e.prototype.pause=function(){this.spectrogramDrawer.haltDisplay(),this.socketWorkletNode.port.postMessage({type:"setState",state:"kPause",filterFunctions:JSON.stringify(this.filterFunctions),newAudioFilter:this.newAudioFilter})},e.prototype.resume=function(){this.spectrogramDrawer.resumeDisplay(),this.socketWorkletNode.port.postMessage({type:"setState",state:"kRecordRemote",filterFunctions:JSON.stringify(this.filterFunctions),newAudioFilter:this.newAudioFilter})},e.prototype.close=function(){if(this.spectrogramDrawer&&this.spectrogramDrawer.haltDisplay(),this.micStream)for(var e=0,t=this.micStream.getTracks();e<t.length;e++)t[e].stop();this.audioContext&&"closed"!=this.audioContext.state&&(this.audioContext.close(),this.audioContext=null),this.refreshTimer&&(clearInterval(this.refreshTimer),this.refreshTimer=null)},e.prototype.stop=function(){this.spectrogramDrawer&&(this.spectrogramDrawer.stopDisplay(),this.socketWorkletNode.port.postMessage({type:"setState",state:"kPause",filterFunctions:JSON.stringify(this.filterFunctions),newAudioFilter:this.newAudioFilter}))},e.prototype.volumeSet=function(e){this.socketWorkletNode.port.postMessage({type:"volume",volume:e,heartMode:"HEART"==this.mode})},e.prototype.playbackSpeedChange=function(e){this.spectrogramDrawer&&this.spectrogramDrawer.alterPlayBackSpeed(100*e)},e.prototype.onModuleAdded=function(e){return r(this,void 0,void 0,(function(){var t,i,o,n;return s(this,(function(r){switch(r.label){case 0:return t="HEART"==this.mode,i={audio:{echoCancellation:!1,googEchoCancellation:{exact:!1},channelCount:2,autoGainControl:!1,noiseSuppression:!1,sampleRate:16e3}},[4,this.loadOpusEncoder()];case 1:return r.sent(),o=this,[4,navigator.mediaDevices.getUserMedia(i)];case 2:return o.micStream=r.sent(),this.micSourceNode=this.audioContext.createMediaStreamSource(this.micStream),this.socketWorkletNode=new AudioWorkletNode(this.audioContext,"socket-worklet"),this.socketWorkletNode.connect(this.audioContext.destination),this.spectrogramDrawer=new a(this.audioContext,this.divID,t),this.spectrogramDrawer.beginDisplay(),this.socketWorkletNode.connect(this.spectrogramDrawer.analyserNode),n="kPause",e&&(n="kRecordMic"),console.log("moduleloaded",e,this.socketWorkletNode,n),[2,!0]}}))}))},e.prototype.connectHeartBiquad=function(e){if(void 0===e&&(e=!0),e)this.biquadFilter.type="lowpass",this.biquadFilter.frequency.value=250,this.micSourceNode.connect(this.biquadFilter);else{this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=40,this.biquadFilter.type="highpass",this.biquadFilter.frequency.value=15,this.biquadFilter.Q.value=.707107,this.gainNode.connect(this.biquadFilter);var t=this.audioContext.createBiquadFilter(),i=this.audioContext.createBiquadFilter(),o=this.audioContext.createBiquadFilter(),a=this.audioContext.createBiquadFilter(),n=this.audioContext.createBiquadFilter(),r=this.audioContext.createBiquadFilter(),s=this.audioContext.createBiquadFilter(),c=this.audioContext.createBiquadFilter();t.type="peaking",t.frequency.value=40,t.Q.value=.7071,t.gain.value=6,this.biquadFilter.connect(t),i.type="lowpass",i.frequency.value=200,i.Q.value=.707107,t.connect(i),o.type="lowpass",o.frequency.value=200,o.Q.value=1.306,i.connect(o),a.type="lowpass",a.frequency.value=200,a.Q.value=.541,o.connect(a),n.type="highpass",n.frequency.value=20,n.Q.value=.5,a.connect(n),r.type="peaking",r.frequency.value=160,r.Q.value=1,r.gain.value=2,n.connect(r),s.type="peaking",s.frequency.value=600,s.Q.value=2,s.gain.value=-3,r.connect(s),c.type="peaking",c.frequency.value=2100,c.Q.value=4.5,c.gain.value=12,s.connect(c),c.connect(this.spectrogramDrawer.analyserNode)}},e.prototype.connectLungBiquad=function(e){if(void 0===e&&(e=!0),e)this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=2,this.micSourceNode.connect(this.gainNode),this.biquadFilter.type="lowpass",this.biquadFilter.frequency.value=400,this.biquadFilter.Q.value=.7071,this.gainNode.connect(this.biquadFilter),this.biquadFilter.connect(this.audioContext.destination);else{var t=new AudioWorkletNode(this.audioContext,"lung-noise-gate");new AudioWorkletNode(this.audioContext,"lung-auto-gain"),this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=60,t.connect(this.gainNode),this.biquadFilter.type="highpass",this.biquadFilter.frequency.value=80,this.biquadFilter.Q.value=.707107,this.gainNode.connect(this.biquadFilter);var i=this.audioContext.createBiquadFilter(),o=this.audioContext.createBiquadFilter(),a=this.audioContext.createBiquadFilter(),n=this.audioContext.createBiquadFilter(),r=this.audioContext.createBiquadFilter(),s=this.audioContext.createBiquadFilter(),c=this.audioContext.createBiquadFilter();i.type="lowpass",i.frequency.value=400,i.Q.value=.707107,this.biquadFilter.connect(i),o.type="lowpass",o.frequency.value=1500,o.Q.value=1.306,i.connect(o),a.type="lowpass",a.frequency.value=1500,a.Q.value=.541,o.connect(a),n.type="highpass",n.frequency.value=20,n.Q.value=.5,a.connect(n),r.type="peaking",r.frequency.value=160,r.Q.value=1,r.gain.value=2,n.connect(r),s.type="peaking",s.frequency.value=600,s.Q.value=2,s.gain.value=-3,r.connect(s),c.type="peaking",c.frequency.value=2100,c.Q.value=4.5,c.gain.value=12,s.connect(c),c.connect(this.spectrogramDrawer.analyserNode)}},e.prototype.workerCros=function(e){var t="importScripts('"+e+"');";return URL.createObjectURL(new Blob([t]))},e.prototype.loadOpusEncoder=function(){return r(this,void 0,void 0,(function(){var e,t;return s(this,(function(i){return e=this.workerCros(new URL("https://cdn.jsdelivr.net/gh/StratoScientific/StethIO-SDK-Web/assets/opus_encoder.js",window.location+"").href),this.encoder=new o(e),console.log(this.encoder),t={sampling_rate:16e3,num_of_channels:1,params:{application:2049,sampling_rate:16e3,frame_duration:20}},[2,this.encoder.setup(t)]}))}))},e.prototype.loadOpusDecoder=function(){return r(this,void 0,void 0,(function(){var e;return s(this,(function(t){return e=this.workerCros(new URL("https://cdn.jsdelivr.net/gh/StratoScientific/StethIO-SDK-Web/assets/opus_decoder.js",window.location+"").href),this.decoder=new i(e),this.decoderOperational=!0,[2,this.decoder.setup({channels:1,sampling_rate:16e3},{})]}))}))},e.prototype.queueBufferForEncodingAndSend=function(){return r(this,void 0,void 0,(function(){var e,t,i,o,a;return s(this,(function(n){switch(n.label){case 0:if(this.encodingBuffers)return[2];if(0===this.buffersToEncode.length)return[2];this.encodingBuffers=!0,e=this.buffersToEncode.shift(),t={timestamp:0,samples:e,transferable:!0},n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.encoder.encode(t)];case 2:for(i=n.sent(),o=0;o<i.length;++o)this.totalBytesSent+=i[o].data.byteLength;return this.encodingBuffers=!1,this.queueBufferForEncodingAndSend(),[3,4];case 3:return a=n.sent(),console.log("encoder.encoder error",a),[3,4];case 4:return[2]}}))}))},e.prototype.decodePackets=function(){var e=this,t="HEART"==this.mode;if(!this.decodingPackets&&0!==this.packetsToDecode.length){this.decodingPackets=!0;var i=this.packetsToDecode.shift();this.decoder.decode(i).then((function(i){i.samples&&(e.totalSamplesIn+=i.samples.length,e.decodedPackets.push(i.samples),e.socketWorkletNode&&(console.log(i),e.socketWorkletNode.port.postMessage({type:"samples",samples:i.samples,heartMode:t,gain:t?e.heartGain:e.lungGain}))),e.decodingPackets=!1,e.decodePackets()}),(function(e){console.log("worklet decoder.decode error",e)})).catch((function(e){return console.log("Unable to decode",e)}))}},e.prototype.setUpFeedbackAnalyser=function(){var e=this;this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=256,this.analyserData=new Float32Array(this.analyser.frequencyBinCount),this.refreshTimer=setInterval((function(){return e.refreshAnalyserData()}),50),this.micSourceNode.connect(this.analyser)},e.prototype.refreshAnalyserData=function(){this.analyser.getFloatFrequencyData(this.analyserData);var e,t=100/24e3*this.analyser.frequencyBinCount,i=2e3/24e3*this.analyser.frequencyBinCount,o=0,a=0,n=0,r=0,s=0,c=0;for(e=0;e<this.analyser.frequencyBinCount;e++)e<t?(o+=this.analyserData[e],a++):e<i?(n+=this.analyserData[e],r++):(s+=this.analyserData[e],c++);o/=a,n/=r,s/=c,this.feedbackGain=1,1.3*n<s&&(this.feedbackGain=s/(1.3*n),console.log("feedback? gain is now: "+this.feedbackGain)),console.log("power low: "+o+"   power mid: "+n+"   power hi: "+s)},e.prototype.setInputEnabled=function(e){this.micStream&&(this.micStream.getAudioTracks()[0].enabled=e)},e.prototype.setAudioBuffer=function(e){var t="HEART"==this.mode,i=e.getChannelData(0);this.socketWorkletNode.port.postMessage({type:"setSamples",samples:i,heartMode:t,gain:t?this.heartGain:this.lungGain})},e.prototype.addAudioSamples=function(e){this.socketWorkletNode.port.postMessage({type:"samples",samples:e,filterFunctions:JSON.stringify(this.filterFunctions),newAudioFilter:this.newAudioFilter})},e.prototype.resampleAudio=function(e){return r(this,void 0,void 0,(function(){return s(this,(function(e){return[2]}))}))},e.prototype.parseBiquadFilter=function(e){var t=this;void 0===e&&(e="heart"),h&&h.iphone7.forEach((function(i){i.name===e&&i.filter&&i.filter.forEach((function(e){t.addFilter(e)}))}))},e.prototype.addFilter=function(e){var t=0,i=0,o=0,a=0,n=0,r=0,s=0,c=0,l=0,h=0,u=[0,0,0,0,0],d=!1,f=e.type;if("peak"==f){var p=e.freq||0;if(0==(m=e.q||0)){var g=e.width||0;g<.001&&(g=.001),m=this.filterFunctions.calculateQFromOctaveWidth(g)}var y=e.gain||0;this.filterFunctions.calculateBiquadPeak(p,this.kAudioFrequencyExact,m,y,t,i,o,a,n),d=!0}if("lowpass2"==f){p=e.freq||0;var m=e.q||0;this.filterFunctions.calculateLP2(p,this.kAudioFrequencyExact,m,u),t=u[0],i=u[1],o=u[2],a=u[3],n=u[4],d=!0}"highpass2"==f&&(p=e.freq||0,m=e.q||0,this.filterFunctions.calculateHP2(p,this.kAudioFrequencyExact,m,u),t=u[0],i=u[1],o=u[2],a=u[3],n=u[4],d=!0),"Butterworth4a"==f&&(p=e.freq||0,this.filterFunctions.calculateBW4Section(p,this.kAudioFrequencyExact,0,u),t=u[0],i=u[1],o=u[2],a=u[3],n=u[4],d=!0),"Butterworth4b"==f&&(p=e.freq||0,this.filterFunctions.calculateBW4Section(p,this.kAudioFrequencyExact,1,u),t=u[0],i=u[1],o=u[2],a=u[3],n=u[4],d=!0),"bandpass2"==f&&(p=e.freq||0,m=e.q||0,this.filterFunctions.calculateBP2(p,this.kAudioFrequencyExact,m,u),t=u[0],i=u[1],o=u[2],a=u[3],n=u[4],d=!0),"raw"==f&&(t=e.a0||0,i=e.a1||0,o=e.a2||0,a=e.b1||0,n=e.b2||0,d=!0),null!=e.a0&&(r=e.a0||0,s=e.a1||0,c=e.a2||0,l=e.b1||0,h=e.b2||0,(Math.abs(t-r)>1e-7||Math.abs(i-s)>1e-7||Math.abs(o-c)>1e-7||Math.abs(a-l)>1e-7||Math.abs(n-h)>1e-7)&&console.log("Error designing ".concat(e," filter"))),d?this.filterFunctions.glsteth_filter_addBiquad(this.newAudioFilter,t,i,o,a,n):console.log("Failed to decode ".concat(e," filter"))},e.endpoint="https://stagingapi.stethio.com",e}();const l=c;var h={note:"Filter updates by Ray Miller with Puck EQ.",date:"2020-04-01T13:21:58Z",default:"iphone7",devices:["iphone7"],iphone7:[{filter:[{type:"highpass2",freq:15,q:.707107,note:"HP 15 Hz",a0:.9984899566,a1:-1.9969799132,a2:.9984899566,b1:-1.9969776329,b2:.9969821934},{type:"peak",note:"earlevel peak filter",freq:40,q:.7071,gain:6},{type:"lowpass2",freq:200,q:.707107,note:"LP 200Hz fs 44100",a0:.0001989714,a1:.0003979428,a2:.0001989714,b1:-1.9597070338,b2:.9605029194},{type:"Butterworth4a",freq:250,note:"BW4A 250Hz fs 44100",a0:.0003128802,a1:.0006257604,a2:.0003128802,b1:-1.9718591139,b2:.9731106348},{type:"Butterworth4b",freq:250,note:"BW4B 250Hz fs 44100",a0:.0003070422,a1:.0006140845,a2:.0003070422,b1:-1.9350664333,b2:.9362946022},{type:"highpass2",freq:20,q:.5,note:"HP 20 Hz"},{type:"peak",note:"peak filter",freq:160,q:1,gain:2},{type:"peak",note:"peak filter",freq:600,q:2,gain:-3},{type:"peak",note:"peak filter",freq:2100,q:4.5,gain:12}],note:"",name:"heart"},{filter:[{type:"highpass2",freq:80,q:.707107,note:"HPF at 80 Hz, fs 44100",a0:.9919727398,a1:-1.9839454796,a2:.9919727398,b1:-1.9838810417,b2:.9840099175},{type:"lowpass2",freq:400,q:.707107,note:"LPF at 400 Hz, fs 44100",a0:.0007803263,a1:.0015606526,a2:.0007803263,b1:-1.9194445715,b2:.9225658767},{type:"Butterworth4a",freq:1500,note:"BW4A 1500 Hz, fs 44100",a0:.0105210738,a1:.0210421475,a2:.0105210738,b1:-1.807774542,b2:.8498588371},{type:"Butterworth4b",freq:1500,note:"BW4B, 1500 Hz, fs 44100",a0:.0095112988,a1:.0190225976,a2:.0095112988,b1:-1.6342708171,b2:.6723160123},{type:"highpass2",freq:20,q:.5,note:"HP 20 Hz"},{type:"peak",note:"peak filter",freq:160,q:1,gain:2},{type:"peak",note:"peak filter",freq:600,q:2,gain:-3},{type:"peak",note:"peak filter",freq:2100,q:4.5,gain:12}],note:"",name:"lungs"}]};return window.AudioEngine=c,t})()}));